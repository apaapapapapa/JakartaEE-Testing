databaseChangeLog:
  - property:
      name: schema.name
      value: PUBLIC

  - changeSet:
      id: drop-task-if-exists
      author: you
      preConditions:
        onFail: MARK_RAN
        tableExists:
          schemaName: ${schema.name}
          tableName: task
      changes:
        - dropTable:
            schemaName: ${schema.name}
            tableName: task
            cascadeConstraints: true
            
  - changeSet:
      id: create-task
      author: you
      changes:
        - createTable:
            schemaName: "${schema.name}"
            tableName: task
            remarks: "Hierarchical tasks"
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: due_date
                  type: DATE
              - column:
                  name: completed
                  type: BOOLEAN
                  defaultValueBoolean: false
              - column:
                  name: parent_id
                  type: BIGINT

        - addForeignKeyConstraint:
            baseTableSchemaName: "${schema.name}"
            baseTableName: task
            baseColumnNames: parent_id
            referencedTableSchemaName: "${schema.name}"
            referencedTableName: task
            referencedColumnNames: id
            constraintName: fk_task_parent
            onDelete: SET NULL

        - createIndex:
            schemaName: "${schema.name}"
            tableName: task
            indexName: idx_task_parent_id
            columns:
              - column:
                  name: parent_id

      rollback:
        - dropTable:
            schemaName: "${schema.name}"
            tableName: task
