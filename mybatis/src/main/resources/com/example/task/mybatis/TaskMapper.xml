<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.task.mybatis.TaskMapper">

  <resultMap id="TaskResultMap" type="com.example.task.Task">
    <id     property="id"       column="id"/>
    <result property="title"    column="title"/>
    <result property="dueDate"  column="due_date"/>
    <result property="completed" column="completed"/>
    <association property="parent" javaType="com.example.task.Task">
      <id property="id" column="parent_id"/>
    </association>
  </resultMap>

  <select id="findAll" resultMap="TaskResultMap">
    SELECT
      id,
      title,
      due_date,
      completed,
      parent_id
    FROM task
  </select>

  <select id="findById" parameterType="int" resultMap="TaskResultMap">
    SELECT
      id,
      title,
      due_date,
      completed,
      parent_id
    FROM task
    WHERE id = #{id}
  </select>

  <select id="findByParentId" parameterType="int" resultMap="TaskResultMap">
    SELECT
      id,
      title,
      due_date,
      completed,
      parent_id
    FROM task
    WHERE parent_id = #{parentId}
  </select>

  <select id="findRootTasks" resultMap="TaskResultMap">
    SELECT
      id,
      title,
      due_date,
      completed,
      parent_id
    FROM task
    WHERE parent_id IS NULL
  </select>

  <insert id="create" parameterType="com.example.task.Task"
          useGeneratedKeys="true" keyProperty="id">
    INSERT INTO task (title, due_date, completed, parent_id)
    VALUES (#{title}, #{dueDate}, #{completed}, #{parent.id})
  </insert>

  <update id="update" parameterType="com.example.task.Task">
    UPDATE task
    SET title     = #{title},
        due_date  = #{dueDate},
        completed = #{completed},
        parent_id = #{parent.id}
    WHERE id = #{id}
  </update>

  <delete id="delete" parameterType="int">
    DELETE FROM task WHERE id = #{id}
  </delete>

  <select id="countIncompleteTasks" resultType="long">
    SELECT COUNT(*) FROM task WHERE completed = FALSE
  </select>

</mapper>
